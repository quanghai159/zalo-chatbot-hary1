const { Zalo, ThreadType } = require("zca-js");
const sharp = require("sharp");
const fs = require("fs");
const path = require("path");

// Cáº¥u hÃ¬nh image metadata getter
async function imageMetadataGetter(filePath) {
    try {
        const data = await fs.promises.readFile(filePath);
        const metadata = await sharp(data).metadata();
        return {
            height: metadata.height,
            width: metadata.width,
            size: metadata.size || data.length,
        };
    } catch (error) {
        console.error("Error getting image metadata:", error);
        return { height: 0, width: 0, size: 0 };
    }
}

// Táº£i cáº¥u hÃ¬nh tá»« file
function loadConfig() {
    try {
        const configPath = path.join(__dirname, "config", "keywords.json");
        const configData = fs.readFileSync(configPath, "utf8");
        return JSON.parse(configData);
    } catch (error) {
        console.error("Error loading config:", error);
        return {
            keywords: [],
            defaultReply: "Xin lá»—i, cÃ³ lá»—i xáº£y ra.",
            settings: { autoReply: true, replyDelay: 1000, logMessages: true }
        };
    }
}

// TÃ¬m tá»« khÃ³a khá»›p
function findMatchingKeyword(message, keywords) {
    const lowerMessage = message.toLowerCase().trim();
    
    for (const item of keywords) {
        const keyword = item.keyword.toLowerCase();
        
        if (item.exactMatch) {
            if (lowerMessage === keyword) {
                return item;
            }
        } else {
            if (lowerMessage.includes(keyword)) {
                return item;
            }
        }
    }
    
    return null;
}

// Ghi log tin nháº¯n
function logMessage(message, threadId, threadType, isOutgoing = false) {
    const timestamp = new Date().toLocaleString("vi-VN");
    const direction = isOutgoing ? "OUT" : "IN";
    const thread = threadType === ThreadType.User ? "User" : "Group";
    
    console.log(`[${timestamp}] ${direction} ${thread} [${threadId}]: ${message}`);
}

// HÃ m chÃ­nh
async function startBot() {
    console.log("ğŸ¤– Äang khá»Ÿi Ä‘á»™ng Zalo Bot...");
    
    // Táº£i cáº¥u hÃ¬nh
    const config = loadConfig();
    console.log(`ğŸ“ ÄÃ£ táº£i ${config.keywords.length} tá»« khÃ³a`);
    
    // Khá»Ÿi táº¡o Zalo
    const zalo = new Zalo({
        imageMetadataGetter,
    });
    
    try {
        // ÄÄƒng nháº­p báº±ng QR Code
        console.log("ğŸ“± Vui lÃ²ng quÃ©t QR Code Ä‘á»ƒ Ä‘Äƒng nháº­p...");
        const api = await zalo.loginQR();
        console.log("âœ… ÄÄƒng nháº­p thÃ nh cÃ´ng!");
        
        // Láº¯ng nghe tin nháº¯n
        api.listener.on("message", async (message) => {
            const isPlainText = typeof message.data.content === "string";
            
            // Bá» qua tin nháº¯n cá»§a chÃ­nh mÃ¬nh vÃ  tin nháº¯n khÃ´ng pháº£i vÄƒn báº£n
            if (message.isSelf || !isPlainText) return;
            
            const messageContent = message.data.content;
            const threadId = message.threadId;
            const threadType = message.type;
            
            // Ghi log tin nháº¯n Ä‘áº¿n
            if (config.settings.logMessages) {
                logMessage(messageContent, threadId, threadType);
            }
            
            // TÃ¬m tá»« khÃ³a khá»›p
            const matchedKeyword = findMatchingKeyword(messageContent, config.keywords);
            
            if (matchedKeyword) {
                // Tráº£ lá»i theo tá»« khÃ³a
                const replyMessage = matchedKeyword.reply;
                
                // Delay trÆ°á»›c khi tráº£ lá»i
                if (config.settings.replyDelay > 0) {
                    await new Promise(resolve => setTimeout(resolve, config.settings.replyDelay));
                }
                
                try {
                    await api.sendMessage(
                        {
                            msg: replyMessage,
                            quote: message.data, // Reply tin nháº¯n gá»‘c
                        },
                        threadId,
                        threadType
                    );
                    
                    console.log(`âœ… ÄÃ£ tráº£ lá»i: "${replyMessage}"`);
                    
                    // Ghi log tin nháº¯n gá»­i
                    if (config.settings.logMessages) {
                        logMessage(replyMessage, threadId, threadType, true);
                    }
                    
                } catch (error) {
                    console.error("âŒ Lá»—i gá»­i tin nháº¯n:", error);
                }
                
            } else if (config.settings.autoReply) {
                // Tráº£ lá»i máº·c Ä‘á»‹nh
                const defaultReply = config.defaultReply;
                
                // Delay trÆ°á»›c khi tráº£ lá»i
                if (config.settings.replyDelay > 0) {
                    await new Promise(resolve => setTimeout(resolve, config.settings.replyDelay));
                }
                
                try {
                    await api.sendMessage(
                        {
                            msg: defaultReply,
                            quote: message.data,
                        },
                        threadId,
                        threadType
                    );
                    
                    console.log(`ğŸ¤– ÄÃ£ tráº£ lá»i máº·c Ä‘á»‹nh: "${defaultReply}"`);
                    
                } catch (error) {
                    console.error("âŒ Lá»—i gá»­i tin nháº¯n máº·c Ä‘á»‹nh:", error);
                }
            }
        });
        
        // Báº¯t Ä‘áº§u láº¯ng nghe
        api.listener.start();
        console.log("ğŸ§ Bot Ä‘ang láº¯ng nghe tin nháº¯n...");
        console.log("ğŸ’¡ GÃµ 'há»— trá»£' Ä‘á»ƒ xem cÃ¡c tÃ­nh nÄƒng cÃ³ sáºµn");
        console.log("ğŸ›‘ Nháº¥n Ctrl+C Ä‘á»ƒ dá»«ng bot");
        
    } catch (error) {
        console.error("âŒ Lá»—i khá»Ÿi Ä‘á»™ng bot:", error);
        process.exit(1);
    }
}

// Xá»­ lÃ½ tÃ­n hiá»‡u dá»«ng
process.on('SIGINT', () => {
    console.log("\nğŸ›‘ Äang dá»«ng bot...");
    process.exit(0);
});

// Khá»Ÿi Ä‘á»™ng bot
startBot().catch(console.error);